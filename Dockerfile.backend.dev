FROM node:24.9.0-alpine

WORKDIR /app

# Instalăm dependențele pentru build și pentru pachete native
# cairo, pango, pixman pentru PDFKit font rendering
# postgresql-client pentru db operations
# redis pentru cache
RUN apk add --no-cache \
    python3 py3-pip make g++ git \
    postgresql-client redis \
    cairo cairo-dev pango pango-dev pixman pixman-dev \
    jpeg-dev giflib-dev librsvg-dev \
    busybox-extras

# Instalăm pnpm (cea mai nouă versiune) și instrumente CLI
RUN npm install -g pnpm@10.19.0 tsx drizzle-kit

# Copiem fișierele de dependințe pentru caching optim
COPY package.json pnpm-lock.yaml .npmrc pnpm-workspace.yaml ./

# Instalăm dependințele folosind EXCLUSIV pnpm
RUN pnpm install

# Copiem scriptul de entrypoint
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expunem portul pentru Backend API server
EXPOSE 5001

# Asigurăm permisiuni de scriere în directorul de lucru
RUN chmod -R 777 /app

ENTRYPOINT ["docker-entrypoint.sh"]

# Comanda de pornire - Backend API server
CMD ["pnpm", "nx", "serve", "api"]

